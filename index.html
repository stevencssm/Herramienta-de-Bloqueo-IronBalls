<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IronBalls ‚Äî Herramienta de Bloqueo v2.9</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500;600;700&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-deep: #08090d;
    --bg-card: #10111a;
    --bg-card-hover: #151725;
    --bg-input: #181a28;
    --bg-surface: #1e2035;
    --border: #262940;
    --border-subtle: #1e2038;
    --text-primary: #ebedf5;
    --text-secondary: #8b90a8;
    --text-muted: #555878;
    --accent-blue: #5b8cff;
    --accent-blue-glow: rgba(91, 140, 255, 0.18);
    --accent-green: #3ee0a5;
    --accent-green-glow: rgba(62, 224, 165, 0.18);
    --accent-red: #ff7b7b;
    --accent-red-glow: rgba(255, 123, 123, 0.18);
    --accent-amber: #ffcb45;
    --accent-amber-glow: rgba(255, 203, 69, 0.18);
    --accent-purple: #b49bff;
    --accent-purple-glow: rgba(180, 155, 255, 0.18);
    --radius-sm: 10px; --radius-md: 14px; --radius-lg: 20px; --radius-xl: 28px;
    --shadow-glow: 0 0 80px rgba(91, 140, 255, 0.1);
    --shadow-card: 0 4px 24px rgba(0,0,0,.3);
    --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
  .bg-mesh { position: fixed; inset: 0; z-index: 0; background: radial-gradient(ellipse 80% 50% at 20% 20%, rgba(74,124,255,0.06) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 80%, rgba(167,139,250,0.04) 0%, transparent 60%), radial-gradient(ellipse 50% 50% at 50% 50%, rgba(52,211,153,0.03) 0%, transparent 60%); animation: meshShift 20s ease-in-out infinite alternate; }
  @keyframes meshShift { 0% { opacity:.7 } 50% { opacity:1 } 100% { opacity:.7 } }
  .bg-grid { position: fixed; inset: 0; z-index: 0; background-image: linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px); background-size: 60px 60px; }
  .app { position: relative; z-index: 1; max-width: 680px; margin: 0 auto; padding: 32px 20px 80px; }
  .header { text-align: center; margin-bottom: 40px; animation: fadeDown .8s ease-out; }
  @keyframes fadeDown { from { opacity:0; transform:translateY(-20px) } to { opacity:1; transform:translateY(0) } }
  .header-logo { display: inline-flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .logo-icon { width: 48px; height: 48px; border-radius: 14px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 20px rgba(74,124,255,0.3); animation: pulse 3s ease-in-out infinite; }
  @keyframes pulse { 0%,100% { box-shadow: 0 4px 20px rgba(74,124,255,0.3) } 50% { box-shadow: 0 4px 30px rgba(74,124,255,0.5) } }
  .header h1 { font-family: 'Playfair Display', serif; font-size: 2rem; font-weight: 800; background: linear-gradient(135deg, var(--text-primary), var(--accent-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
  .header-sub { font-size: .88rem; color: var(--text-secondary); margin-top: 6px; line-height: 1.5; }
  .version-badge { display: inline-block; padding: 3px 10px; border-radius: 20px; font-size: .7rem; font-weight: 600; color: var(--accent-blue); background: var(--accent-blue-glow); border: 1px solid rgba(74,124,255,.2); margin-top: 10px; letter-spacing: .05em; }
  .pdt-banner { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px 20px; margin-bottom: 28px; font-size: .84rem; color: #a0a6c0; line-height: 1.7; animation: fadeUp .6s ease-out; position: relative; overflow: hidden; }
  .pdt-banner::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background: linear-gradient(180deg, var(--accent-blue), var(--accent-purple)); border-radius: 3px 0 0 3px; }
  .pdt-banner strong { color: var(--text-primary); }
  .progress-bar { display: flex; gap: 6px; margin-bottom: 32px; padding: 0 4px; animation: fadeDown .6s ease-out; }
  .progress-step { flex: 1; height: 3px; border-radius: 3px; background: var(--border); transition: background .4s ease; }
  .progress-step.done { background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple)); }
  .progress-step.current { background: linear-gradient(90deg, var(--accent-blue), transparent); }
  .card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-lg); padding: 28px; margin-bottom: 20px; position: relative; overflow: hidden; transition: var(--transition); animation: fadeUp .6s ease-out backwards; box-shadow: var(--shadow-card); }
  .card:nth-child(1){animation-delay:.05s} .card:nth-child(2){animation-delay:.1s} .card:nth-child(3){animation-delay:.15s} .card:nth-child(4){animation-delay:.2s} .card:nth-child(5){animation-delay:.25s} .card:nth-child(6){animation-delay:.3s}
  @keyframes fadeUp { from { opacity:0; transform:translateY(24px) } to { opacity:1; transform:translateY(0) } }
  .card:hover { border-color: rgba(74,124,255,.15); background: var(--bg-card-hover); }
  .card::before { content:''; position:absolute; top:0; left:0; right:0; height:1px; background:linear-gradient(90deg, transparent, rgba(74,124,255,.3), transparent); opacity:0; transition: opacity var(--transition); }
  .card:hover::before { opacity:1; }
  .card.strike-error { border-color: rgba(255,123,123,.35) !important; }
  .card.strike-error::after { content:''; position:absolute; top:0; left:0; right:0; height:2px; background: linear-gradient(90deg, transparent, var(--accent-red), transparent); }
  .step-label { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .step-num { width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); color: white; font-size: .75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: background .3s ease; }
  .step-num.err { background: var(--accent-red); }
  .step-title { font-size: .8rem; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: #cdd0e3; }
  .step-hint { font-size: .84rem; color: #8f95b2; margin-bottom: 18px; line-height: 1.6; padding-left: 38px; }
  .strike-diagram { margin-top: 16px; padding: 14px 16px; background: var(--bg-surface); border-radius: var(--radius-sm); border: 1px solid var(--border); opacity: 0; transform: translateY(-6px); transition: all .4s ease; }
  .strike-diagram.vis { opacity: 1; transform: translateY(0); }
  .sd-title { font-size: .68rem; font-weight: 700; text-transform: uppercase; letter-spacing: .1em; color: #8090b8; margin-bottom: 10px; }
  .sd-track { position: relative; height: 28px; display: flex; align-items: center; }
  .sd-line { position: absolute; left: 0; right: 0; height: 2px; background: var(--border); border-radius: 2px; }
  .sd-line.ok { background: linear-gradient(90deg, var(--accent-green), var(--accent-blue)); }
  .sd-line.warn { background: linear-gradient(90deg, var(--accent-red), var(--accent-amber)); }
  .sd-marker { position: absolute; display: flex; flex-direction: column; align-items: center; transform: translateX(-50%); }
  .sd-pin { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg-deep); z-index: 1; }
  .sd-pin.buy { background: var(--accent-green); box-shadow: 0 0 8px rgba(62,224,165,.4); }
  .sd-pin.sell { background: var(--accent-red); box-shadow: 0 0 8px rgba(255,123,123,.4); }
  .sd-pin.buy-warn { background: var(--accent-amber); box-shadow: 0 0 8px rgba(255,203,69,.4); }
  .sd-pin.sell-warn { background: var(--accent-amber); box-shadow: 0 0 8px rgba(255,203,69,.4); }
  .sd-tag { font-family: 'JetBrains Mono', monospace; font-size: .65rem; font-weight: 700; margin-top: 4px; white-space: nowrap; }
  .sd-tag.tg { color: var(--accent-green); }
  .sd-tag.tr { color: var(--accent-red); }
  .sd-tag.ta { color: var(--accent-amber); }
  .sd-status { margin-top: 10px; font-size: .75rem; display: flex; align-items: center; gap: 6px; }
  .sd-status.ok { color: var(--accent-green); }
  .sd-status.warn { color: var(--accent-amber); }
  .sd-status.err { color: var(--accent-red); }
  .opts { display: grid; gap: 10px; }
  .opts.c2 { grid-template-columns: 1fr 1fr; }
  .opts.c3 { grid-template-columns: 1fr 1fr 1fr; }
  .opts.c4 { grid-template-columns: 1fr 1fr; }
  .opt { position: relative; background: var(--bg-input); border: 1.5px solid var(--border); border-radius: var(--radius-md); padding: 16px 14px; cursor: pointer; transition: all .25s ease; text-align: center; overflow: hidden; }
  .opt:hover { border-color: rgba(74,124,255,.3); transform: translateY(-2px); box-shadow: 0 4px 16px rgba(0,0,0,.2); }
  .opt.on { border-color: var(--accent-blue); background: linear-gradient(135deg, rgba(74,124,255,.08), rgba(167,139,250,.05)); box-shadow: 0 0 24px var(--accent-blue-glow); }
  .opt.on-green { border-color: var(--accent-green); background: linear-gradient(135deg, rgba(52,211,153,.08), rgba(52,211,153,.03)); box-shadow: 0 0 24px var(--accent-green-glow); }
  .opt.on-red { border-color: var(--accent-red); background: linear-gradient(135deg, rgba(248,113,113,.08), rgba(248,113,113,.03)); box-shadow: 0 0 24px var(--accent-red-glow); }
  .opt.on-amber { border-color: var(--accent-amber); background: linear-gradient(135deg, rgba(251,191,36,.08), rgba(251,191,36,.03)); box-shadow: 0 0 24px var(--accent-amber-glow); }
  .opt-dot { width: 36px; height: 36px; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: transform .3s ease; }
  .opt:hover .opt-dot { transform: scale(1.15); }
  .opt.on .opt-dot, .opt.on-green .opt-dot, .opt.on-red .opt-dot, .opt.on-amber .opt-dot { transform: scale(1.2); }
  .dg { background: rgba(52,211,153,.15); color: var(--accent-green); }
  .db { background: rgba(74,124,255,.15); color: var(--accent-blue); }
  .da { background: rgba(251,191,36,.15); color: var(--accent-amber); }
  .dr { background: rgba(248,113,113,.15); color: var(--accent-red); }
  .dp { background: rgba(167,139,250,.15); color: var(--accent-purple); }
  .opt-name { font-size: .92rem; font-weight: 700; margin-bottom: 3px; color: #dde0f0; }
  .opt-sub { font-size: .74rem; color: #8090b8; font-family: 'JetBrains Mono', monospace; letter-spacing: .02em; }
  .irow { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .irow.s1 { grid-template-columns: 1fr; }
  .ig { position: relative; }
  .ig label { display: block; font-size: .76rem; font-weight: 600; color: #8090b8; margin-bottom: 7px; text-transform: uppercase; letter-spacing: .07em; }
  .ig input { width: 100%; padding: 14px 16px; background: var(--bg-input); border: 1.5px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 500; outline: none; transition: all .25s ease; }
  .ig input::placeholder { color: var(--text-muted); font-weight: 400; }
  .ig input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px var(--accent-blue-glow); }
  .ig input:hover:not(:focus) { border-color: rgba(74,124,255,.25); }
  .ig input.input-err { border-color: var(--accent-red) !important; box-shadow: 0 0 0 3px var(--accent-red-glow) !important; }
  .ig input.input-warn { border-color: var(--accent-amber) !important; box-shadow: 0 0 0 3px var(--accent-amber-glow) !important; }
  .ig input.input-ok { border-color: var(--accent-green) !important; box-shadow: 0 0 0 3px var(--accent-green-glow) !important; }
  .itag { position: absolute; right: 12px; top: 50%; transform: translateY(20%); font-size: .7rem; font-weight: 700; color: #8090b8; background: rgba(30,32,53,.9); padding: 2px 8px; border-radius: 4px; pointer-events: none; border: 1px solid rgba(255,255,255,.06); }
  .spread-info { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 14px; padding: 10px 14px; background: rgba(91,140,255,.07); border: 1px solid rgba(91,140,255,.12); border-radius: var(--radius-sm); font-size: .84rem; color: #a8aec8; opacity: 0; transform: translateY(-8px); transition: all .4s ease; }
  .spread-info.vis { opacity: 1; transform: translateY(0); }
  .spread-info strong { font-family: 'JetBrains Mono', monospace; color: var(--accent-blue); font-weight: 700; }
  .target-area { margin-top: 16px; overflow: hidden; max-height: 0; opacity: 0; transition: max-height .5s cubic-bezier(.4,0,.2,1), opacity .4s ease; }
  .target-area.vis { max-height: 200px; opacity: 1; }
  .target-ctx { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border-radius: var(--radius-sm); font-size: .82rem; margin-bottom: 14px; line-height: 1.5; }
  .target-ctx.cg { background: rgba(62,224,165,.1); color: var(--accent-green); border: 1px solid rgba(62,224,165,.18); }
  .target-ctx.cr { background: rgba(255,123,123,.1); color: var(--accent-red); border: 1px solid rgba(255,123,123,.18); }
  .asset-box { display: flex; align-items: center; gap: 14px; padding: 14px 18px; background: var(--bg-input); border: 1.5px solid var(--border); border-radius: var(--radius-md); }
  .asset-tick { font-family: 'JetBrains Mono', monospace; font-size: 1.3rem; font-weight: 700; }
  .asset-name { font-size: .82rem; color: #8090b8; }
  .asset-live { margin-left: auto; display: flex; align-items: center; gap: 6px; font-size: .72rem; color: var(--accent-green); font-weight: 600; }
  .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-green); animation: blink 1.5s ease-in-out infinite; }
  @keyframes blink { 0%,100% { opacity:1 } 50% { opacity:.3 } }
  .results { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: var(--radius-xl); padding: 40px 28px; margin-top: 32px; text-align: center; position: relative; overflow: hidden; animation: fadeUp .7s ease-out backwards; animation-delay: .4s; transition: all .5s ease; box-shadow: var(--shadow-card); }
  .results.has { border-color: rgba(91,140,255,.3); box-shadow: var(--shadow-glow), 0 8px 40px rgba(0,0,0,.4); }
  .results::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:radial-gradient(circle, rgba(91,140,255,.05), transparent 60%); pointer-events:none; }
  .r-label { font-size: .76rem; font-weight: 700; text-transform: uppercase; letter-spacing: .15em; color: #8090b8; margin-bottom: 8px; }
  .r-sub { font-size: .84rem; font-weight: 500; color: #a8aec8; margin-bottom: 16px; }
  .r-val { font-family: 'JetBrains Mono', monospace; font-size: 3.5rem; font-weight: 700; line-height: 1; margin-bottom: 6px; transition: all .5s ease; }
  .r-val.pos { color: var(--accent-green); }
  .r-val.neg { color: var(--accent-red); }
  .r-val.neu { color: #555878; }
  .r-unit { font-size: 1.4rem; font-weight: 500; opacity: .6; margin-left: 4px; }
  .r-conv { font-size: .85rem; color: #8090b8; margin-top: 6px; font-family: 'JetBrains Mono', monospace; }
  .r-div { display: flex; align-items: center; gap: 12px; margin: 24px 0 20px; color: #8090b8; }
  .r-div::before, .r-div::after { content:''; flex:1; height:1px; background: var(--border); }
  .r-div span { font-size: .7rem; font-weight: 700; text-transform: uppercase; letter-spacing: .12em; white-space: nowrap; }
  .t-box { background: var(--bg-input); border-radius: var(--radius-md); padding: 22px; border: 1px solid var(--border); opacity: 0; transform: translateY(8px); transition: all .5s ease; }
  .t-box.vis { opacity: 1; transform: translateY(0); }
  .t-lbl { font-size: .72rem; font-weight: 700; text-transform: uppercase; letter-spacing: .12em; margin-bottom: 10px; }
  .t-lbl.lg { color: var(--accent-green); }
  .t-lbl.lr { color: var(--accent-red); }
  .t-val { font-family: 'JetBrains Mono', monospace; font-size: 2.2rem; font-weight: 700; line-height: 1; }
  .t-val.vg { color: var(--accent-green); }
  .t-val.vr { color: var(--accent-red); }
  .t-sub { font-size: .78rem; color: #8090b8; margin-top: 6px; font-family: 'JetBrains Mono', monospace; }
  .t-expl { font-size: .8rem; color: #a0a6c0; margin-top: 10px; line-height: 1.6; border-top: 1px solid var(--border); padding-top: 10px; }
  .edu { margin-top: 28px; padding-top: 24px; border-top: 1px solid var(--border); opacity: 0; transform: translateY(12px); transition: all .5s ease; }
  .edu.vis { opacity: 1; transform: translateY(0); }
  .edu-title { display: flex; align-items: center; gap: 8px; font-size: .76rem; font-weight: 700; text-transform: uppercase; letter-spacing: .12em; color: #8090b8; margin-bottom: 18px; }
  .edu-title .ei { width: 22px; height: 22px; border-radius: 6px; background: rgba(167,139,250,.15); color: var(--accent-purple); display: flex; align-items: center; justify-content: center; font-size: 11px; }
  .edu-vars { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
  .ev { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; border-radius: 6px; font-size: .76rem; font-family: 'JetBrains Mono', monospace; background: var(--bg-input); border: 1px solid var(--border); }
  .ev-icon { font-size: .85rem; }
  .ev-name { color: #8090b8; font-family: 'DM Sans', sans-serif; }
  .ev-val { color: var(--text-primary); font-weight: 600; }
  .edu-steps { display: flex; flex-direction: column; }
  .es { display: flex; align-items: flex-start; gap: 14px; padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,.04); }
  .es:last-child { border-bottom: none; }
  .es-n { width: 24px; height: 24px; border-radius: 50%; flex-shrink: 0; background: var(--bg-input); border: 1px solid rgba(255,255,255,.1); display: flex; align-items: center; justify-content: center; font-size: .68rem; font-weight: 700; color: #8090b8; margin-top: 1px; }
  .es-n.done { background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)); border: none; color: white; }
  .es-b { flex: 1; }
  .es-d { font-size: .84rem; color: #a0a6c0; line-height: 1.6; margin-bottom: 6px; }
  .es-eq { font-family: 'JetBrains Mono', monospace; font-size: .85rem; padding: 10px 14px; border-radius: 8px; background: var(--bg-surface); border-left: 3px solid var(--border); color: var(--text-primary); line-height: 1.7; }
  .es-eq.final { background: rgba(91,140,255,.08); border-left-color: var(--accent-blue); font-size: .92rem; font-weight: 600; }
  .edu-tip { margin-top: 16px; padding: 14px 16px; border-radius: var(--radius-sm); font-size: .84rem; line-height: 1.65; }
  .edu-tip.tg { background: rgba(62,224,165,.1); border: 1px solid rgba(62,224,165,.2); color: #6de8bc; }
  .edu-tip.ta { background: rgba(255,203,69,.08); border: 1px solid rgba(255,203,69,.18); color: #ffd666; }
  .edu-tip.tb { background: rgba(91,140,255,.1); border: 1px solid rgba(91,140,255,.2); color: #7fa4ff; }
  .edu-tip.tr { background: rgba(255,123,123,.1); border: 1px solid rgba(255,123,123,.2); color: #ff9898; }
  .empty { padding: 24px 0; }
  .empty-ico { font-size: 2.5rem; margin-bottom: 12px; opacity: .35; }
  .empty-txt { font-size: .9rem; color: #6a7098; }
  .alert { display: flex; align-items: flex-start; gap: 10px; padding: 12px 16px; border-radius: var(--radius-sm); font-size: .8rem; line-height: 1.5; margin-top: 10px; animation: pop .3s ease-out; }
  .alert + .alert { margin-top: 6px; }
  .alert.warn { background: rgba(255,123,123,.1); border: 1px solid rgba(255,123,123,.2); color: var(--accent-red); }
  .alert.info { background: rgba(91,140,255,.08); border: 1px solid rgba(91,140,255,.15); color: var(--accent-blue); }
  .alert.hint { background: rgba(255,203,69,.08); border: 1px solid rgba(255,203,69,.15); color: var(--accent-amber); }
  .alert-icon { flex-shrink: 0; font-size: 1rem; margin-top: 1px; }
  .alert strong { font-weight: 700; }
  .fix-chip { display: inline-block; margin-top: 6px; padding: 3px 10px; background: rgba(91,140,255,.15); border: 1px solid rgba(91,140,255,.25); border-radius: 20px; font-size: .74rem; font-weight: 700; color: var(--accent-blue); cursor: pointer; transition: background .2s; }
  .fix-chip:hover { background: rgba(91,140,255,.3); }
  .fix-chip-lg { padding: 5px 14px; font-size: .78rem; margin-top: 10px; background: rgba(255,123,123,.15); border-color: rgba(255,123,123,.3); color: #ff9898; }
  .fix-chip-lg:hover { background: rgba(255,123,123,.28); }
  .alert.direction-error { background: rgba(255,80,80,.08); border: 1.5px solid rgba(255,80,80,.35); color: var(--text-primary); flex-direction: column; gap: 0; padding: 14px 16px; }
  .de-header { font-size: .88rem; font-weight: 700; color: #ff9898; margin-bottom: 8px; }
  .de-body { font-size: .81rem; color: #b0b6cc; line-height: 1.6; }
  .de-body strong { color: #dde0f0; }
  .de-body span[style] { color: #7a80a0 !important; font-size: .76rem; display: block; margin-top: 4px; }
  .de-action { margin-top: 2px; }
  .alert.valid-struct { background: rgba(62,224,165,.07); border: 1px solid rgba(62,224,165,.2); color: #6de8bc; font-size: .81rem; }
  .lock-badge { display: flex; align-items: flex-start; gap: 10px; padding: 12px 16px; border-radius: var(--radius-sm); font-size: .82rem; font-weight: 500; margin-bottom: 16px; line-height: 1.5; width: 100%; }
  .lock-badge.lb-credit { background: rgba(62,224,165,.1); border: 1px solid rgba(62,224,165,.18); color: var(--text-secondary); }
  .lock-badge.lb-debit { background: rgba(180,155,255,.1); border: 1px solid rgba(180,155,255,.18); color: var(--text-secondary); }
  .lock-badge .lb-arrow { font-size: 1.1rem; }
  .lock-badge .lb-name { color: var(--text-primary); }
  .ripple { position: absolute; border-radius: 50%; background: rgba(74,124,255,.3); transform: scale(0); animation: rpl .6s ease-out; pointer-events: none; }
  @keyframes rpl { to { transform: scale(4); opacity: 0; } }
  @keyframes pop { from { opacity:0; transform:translateY(10px) } to { opacity:1; transform:translateY(0) } }
  .pop { animation: pop .4s ease-out; }
  @media (max-width: 480px) {
    .app { padding: 20px 14px 60px; }
    .card { padding: 20px; }
    .r-val { font-size: 2.6rem; }
    .t-val { font-size: 1.8rem; }
    .opts.c4 { grid-template-columns: 1fr 1fr; }
    .opts.c3 { grid-template-columns: 1fr; }
    .header h1 { font-size: 1.6rem; }
  }
</style>
</head>
<body>
<div class="bg-mesh"></div>
<div class="bg-grid"></div>
<div class="app">
  <header class="header">
    <div class="header-logo">
      <div class="logo-icon">üîí</div>
      <h1>IronBalls</h1>
    </div>
    <p class="header-sub">Calcula cu√°nto necesitas para bloquear ganancia o limitar p√©rdida<br>sin cerrar tu posici√≥n intrad√≠a</p>
    <span class="version-badge">v2.9 ‚Äî LOCK TOOL</span>
  </header>
  <div class="pdt-banner">
    <strong>¬øPara qu√© sirve?</strong> Si tienes una cuenta con menos de $25k (regla PDT), no puedes hacer day trades ilimitados. El bloqueo te permite asegurar ganancias o limitar p√©rdidas abriendo un spread opuesto, sin necesidad de cerrar la posici√≥n original el mismo d√≠a.
  </div>
  <div class="progress-bar">
    <div class="progress-step" id="p1"></div>
    <div class="progress-step" id="p2"></div>
    <div class="progress-step" id="p3"></div>
    <div class="progress-step" id="p4"></div>
    <div class="progress-step" id="p5"></div>
    <div class="progress-step" id="p6"></div>
  </div>
  <div class="card">
    <div class="step-label"><div class="step-num">1</div><span class="step-title">Tipo de Spread Inicial</span></div>
    <p class="step-hint"><strong style="color:var(--accent-green)">PCS/CCS</strong> = recibiste cr√©dito ¬∑ <strong style="color:var(--accent-amber)">PDS/CDS</strong> = pagaste d√©bito</p>
    <div class="opts c4">
      <button class="opt" onclick="pick(this,'spread','PCS')"><div class="opt-dot dg">‚Üë</div><div class="opt-name">Put Credit</div><div class="opt-sub">PCS ¬∑ Alcista</div></button>
      <button class="opt" onclick="pick(this,'spread','CCS')"><div class="opt-dot dr">‚Üì</div><div class="opt-name">Call Credit</div><div class="opt-sub">CCS ¬∑ Bajista</div></button>
      <button class="opt" onclick="pick(this,'spread','PDS')"><div class="opt-dot dr">‚Üì</div><div class="opt-name">Put Debit</div><div class="opt-sub">PDS ¬∑ Bajista</div></button>
      <button class="opt" onclick="pick(this,'spread','CDS')"><div class="opt-dot dg">‚Üë</div><div class="opt-name">Call Debit</div><div class="opt-sub">CDS ¬∑ Alcista</div></button>
    </div>
  </div>
  <div class="card">
    <div class="step-label"><div class="step-num">2</div><span class="step-title">Unidad de Medida</span></div>
    <p class="step-hint">Puntos del mercado (1 pt = $100) o D√≥lares directos.</p>
    <div class="opts c2">
      <button class="opt on" onclick="pick(this,'unit','pts')"><div class="opt-dot dp">üìä</div><div class="opt-name">Puntos</div><div class="opt-sub">1 pt = $100</div></button>
      <button class="opt" onclick="pick(this,'unit','usd')"><div class="opt-dot dg">üíµ</div><div class="opt-name">D√≥lares</div><div class="opt-sub">USD directos</div></button>
    </div>
  </div>
  <div class="card">
    <div class="step-label"><div class="step-num">3</div><span class="step-title">Activo</span></div>
    <p class="step-hint">Optimizado para opciones sobre √≠ndices.</p>
    <div class="asset-box">
      <div><div class="asset-tick">SPX</div><div class="asset-name">S&amp;P 500 Index</div></div>
      <div class="asset-live"><div class="live-dot"></div>ACTIVO</div>
    </div>
  </div>
  <div class="card" id="strikesCard">
    <div class="step-label"><div class="step-num" id="strikesNum">4</div><span class="step-title">Strikes del Spread Inicial</span></div>
    <p class="step-hint"><strong style="color:var(--accent-green)">Buy</strong> = strike que compraste ¬∑ <strong style="color:var(--accent-red)">Sell</strong> = strike que vendiste</p>
    <div class="irow">
      <div class="ig"><label>Compra (Buy)</label><input type="number" id="inBuy" placeholder="6930" oninput="calc()"><span class="itag">BUY</span></div>
      <div class="ig"><label>Venta (Sell)</label><input type="number" id="inSell" placeholder="6935" oninput="calc()"><span class="itag">SELL</span></div>
    </div>
    <div class="spread-info" id="spInfo">Ancho del spread: <strong id="spW">‚Äî</strong></div>
    <div class="strike-diagram" id="strikeDiagram">
      <div class="sd-title">ESTRUCTURA DE STRIKES</div>
      <div class="sd-track" id="sdTrack"><div class="sd-line" id="sdLine"></div></div>
      <div class="sd-status" id="sdStatus"></div>
    </div>
    <div id="alertStrikes"></div>
  </div>
  <div class="card">
    <div class="step-label"><div class="step-num">5</div><span class="step-title" id="premTitle">Prima Recibida / Pagada</span></div>
    <p class="step-hint" id="premHint">Ingresa la prima de tu spread original.</p>
    <div class="irow s1">
      <div class="ig"><label id="premLbl">Prima</label><input type="number" id="inPrem" placeholder="1.80" step="0.01" oninput="calc()"><span class="itag" id="premTag">PTS</span></div>
    </div>
    <div id="alertPrem"></div>
  </div>
  <div class="card">
    <div class="step-label"><div class="step-num">6</div><span class="step-title">Objetivo del Bloqueo</span></div>
    <p class="step-hint">¬øQuieres asegurar ganancia, limitar p√©rdida, o llegar a break-even?</p>
    <div class="opts c3">
      <button class="opt" onclick="pickGoal(this,'profit')"><div class="opt-dot dg">üí∞</div><div class="opt-name">Asegurar Ganancia</div><div class="opt-sub">Lock profit</div></button>
      <button class="opt" onclick="pickGoal(this,'loss')"><div class="opt-dot dr">üõ°Ô∏è</div><div class="opt-name">Limitar P√©rdida</div><div class="opt-sub">Max loss cap</div></button>
      <button class="opt on-amber" onclick="pickGoal(this,'be')"><div class="opt-dot da">‚öñÔ∏è</div><div class="opt-name">Break-Even</div><div class="opt-sub">$0 neto</div></button>
    </div>
    <div class="target-area" id="tArea">
      <div class="target-ctx cg" id="tCtx">Ingresa la ganancia m√≠nima que deseas asegurar.</div>
      <div class="irow s1"><div class="ig"><label id="tLbl">Ganancia Deseada</label><input type="number" id="inTarget" placeholder="0.50" step="0.01" oninput="calc()"><span class="itag" id="tTag">PTS</span></div></div>
      <div id="alertTarget"></div>
    </div>
  </div>
  <div class="results" id="resPanel">
    <div id="empty" class="empty"><div class="empty-ico">üéØ</div><p class="empty-txt">Completa los par√°metros para calcular tu bloqueo</p></div>
    <div id="resContent" style="display:none">
      <div class="r-label" id="rLabel">CR√âDITO PARA BLOQUEO</div>
      <div class="r-sub" id="rSub"></div>
      <div class="r-val neu" id="rVal">0.00<span class="r-unit" id="rUnit">pts</span></div>
      <div class="r-conv" id="rConv"></div>
      <div id="tWrap" style="display:none">
        <div class="r-div"><span id="tDivLbl">Tu Objetivo</span></div>
        <div class="t-box" id="tBox">
          <div class="t-lbl lg" id="tBoxLbl"></div>
          <div class="t-val vg" id="tBoxVal"></div>
          <div class="t-sub" id="tBoxSub"></div>
          <div class="t-expl" id="tBoxExpl"></div>
        </div>
      </div>
      <div class="edu" id="edu">
        <div class="edu-title"><div class="ei">∆í</div>C√ìMO SE CALCULA</div>
        <div class="edu-vars" id="eduVars"></div>
        <div class="edu-steps" id="eduSteps"></div>
        <div id="eduTip"></div>
      </div>
    </div>
  </div>
</div>
<script>
const S = { type:null, unit:'pts', buy:null, sell:null, prem:null, goal:'be', target:null };

const STRIKE_RULES = {
  PCS: {
    check: (buy, sell) => sell > buy,
    errorMsg: (buy, sell) =>
      `En un <strong>Put Credit Spread (PCS)</strong>, la pata Sell debe ser el strike <strong>mayor</strong> (put corto m√°s cercano al dinero) y la pata Buy el strike <strong>menor</strong> (put largo m√°s lejano).<br>
       <span style="opacity:.75">Correcto: Sell ${Math.max(buy,sell)} / Buy ${Math.min(buy,sell)}</span>`,
    swapMsg: (buy, sell) => ({ newBuy: Math.min(buy,sell), newSell: Math.max(buy,sell) }),
    diagram: (buy, sell) => ({ left: { val: buy, label: `BUY ${buy}`, cls: 'buy', tagCls: 'tg' }, right: { val: sell, label: `SELL ${sell}`, cls: 'sell', tagCls: 'tr' }, lineOk: sell > buy, hint: `Sell (${sell}) > Buy (${buy}) ‚úì ‚Äî spread alcista correcto` }),
    dir: 'Alcista ‚Äî precio por encima del Sell', dirColor: 'green'
  },
  CCS: {
    check: (buy, sell) => buy > sell,
    errorMsg: (buy, sell) =>
      `En un <strong>Call Credit Spread (CCS)</strong>, la pata Sell debe ser el strike <strong>menor</strong> (call corto m√°s cercano al dinero) y la pata Buy el strike <strong>mayor</strong> (call largo m√°s lejano).<br>
       <span style="opacity:.75">Correcto: Sell ${Math.min(buy,sell)} / Buy ${Math.max(buy,sell)}</span>`,
    swapMsg: (buy, sell) => ({ newBuy: Math.max(buy,sell), newSell: Math.min(buy,sell) }),
    diagram: (buy, sell) => ({ left: { val: sell, label: `SELL ${sell}`, cls: 'sell', tagCls: 'tr' }, right: { val: buy, label: `BUY ${buy}`, cls: 'buy', tagCls: 'tg' }, lineOk: buy > sell, hint: `Sell (${sell}) < Buy (${buy}) ‚úì ‚Äî spread bajista correcto` }),
    dir: 'Bajista ‚Äî precio por debajo del Sell', dirColor: 'red'
  },
  PDS: {
    check: (buy, sell) => buy > sell,
    errorMsg: (buy, sell) =>
      `En un <strong>Put Debit Spread (PDS)</strong>, la pata Buy debe ser el strike <strong>mayor</strong> (put largo m√°s cercano al dinero) y la pata Sell el strike <strong>menor</strong> (put corto m√°s lejano).<br>
       <span style="opacity:.75">Correcto: Buy ${Math.max(buy,sell)} / Sell ${Math.min(buy,sell)}</span>`,
    swapMsg: (buy, sell) => ({ newBuy: Math.max(buy,sell), newSell: Math.min(buy,sell) }),
    diagram: (buy, sell) => ({ left: { val: sell, label: `SELL ${sell}`, cls: 'sell', tagCls: 'tr' }, right: { val: buy, label: `BUY ${buy}`, cls: 'buy', tagCls: 'tg' }, lineOk: buy > sell, hint: `Buy (${buy}) > Sell (${sell}) ‚úì ‚Äî spread bajista correcto` }),
    dir: 'Bajista ‚Äî precio cae por debajo del Buy', dirColor: 'red'
  },
  CDS: {
    check: (buy, sell) => sell > buy,
    errorMsg: (buy, sell) =>
      `En un <strong>Call Debit Spread (CDS)</strong>, la pata Buy debe ser el strike <strong>menor</strong> (call largo m√°s cercano al dinero) y la pata Sell el strike <strong>mayor</strong> (call corto m√°s lejano).<br>
       <span style="opacity:.75">Correcto: Buy ${Math.min(buy,sell)} / Sell ${Math.max(buy,sell)}</span>`,
    swapMsg: (buy, sell) => ({ newBuy: Math.min(buy,sell), newSell: Math.max(buy,sell) }),
    diagram: (buy, sell) => ({ left: { val: buy, label: `BUY ${buy}`, cls: 'buy', tagCls: 'tg' }, right: { val: sell, label: `SELL ${sell}`, cls: 'sell', tagCls: 'tr' }, lineOk: sell > buy, hint: `Buy (${buy}) < Sell (${sell}) ‚úì ‚Äî spread alcista correcto` }),
    dir: 'Alcista ‚Äî precio sube por encima del Sell', dirColor: 'green'
  }
};

function validateStrikes(buy, sell, type) {
  if (!type || buy === null || sell === null) return null;
  const rule = STRIKE_RULES[type];
  if (!rule) return null;
  if (buy === sell) return { ok: false, fatal: true, msg: 'Los strikes no pueden ser iguales.' };
  const ok = rule.check(buy, sell);
  return { ok, fatal: !ok, msg: ok ? null : rule.errorMsg(buy, sell), swap: rule.swapMsg(buy, sell), diagram: rule.diagram(buy, sell) };
}

function renderDiagram(buy, sell, type) {
  const diag = document.getElementById('strikeDiagram');
  const track = document.getElementById('sdTrack');
  const line = document.getElementById('sdLine');
  const status = document.getElementById('sdStatus');
  if (!type || buy === null || sell === null || buy === sell) { diag.classList.remove('vis'); return; }
  const rule = STRIKE_RULES[type];
  const d = rule.diagram(buy, sell);
  const ok = rule.check(buy, sell);
  const lo = Math.min(buy, sell), hi = Math.max(buy, sell);
  const range = hi - lo, pad = range * 0.15, total = range + pad * 2;
  const pct = v => ((v - lo + pad) / total * 100).toFixed(1) + '%';
  track.querySelectorAll('.sd-marker').forEach(m => m.remove());
  line.className = 'sd-line ' + (ok ? 'ok' : 'warn');
  [d.left, d.right].forEach(mk => {
    const el = document.createElement('div');
    el.className = 'sd-marker';
    el.style.left = pct(mk.val);
    const pinCls = ok ? mk.cls : (mk.cls === 'buy' ? 'buy-warn' : 'sell-warn');
    el.innerHTML = `<div class="sd-pin ${pinCls}"></div><div class="sd-tag ${ok ? mk.tagCls : 'ta'}">${mk.label}</div>`;
    track.appendChild(el);
  });
  status.className = 'sd-status ' + (ok ? 'ok' : 'err');
  status.innerHTML = ok ? `‚úÖ ${d.hint}` : `‚ùå Strikes invertidos ‚Äî ver alerta abajo`;
  diag.classList.add('vis');
}

function applySwap(type, buy, sell) {
  const sw = STRIKE_RULES[type].swapMsg(buy, sell);
  document.getElementById('inBuy').value = sw.newBuy;
  document.getElementById('inSell').value = sw.newSell;
  calc();
}

function pick(btn, group, val) {
  ripple(btn);
  btn.parentElement.querySelectorAll('.opt').forEach(b => { b.className = 'opt'; });
  btn.classList.add('opt','on');
  if (group === 'spread') S.type = val;
  if (group === 'unit') {
    S.unit = val;
    document.getElementById('premTag').textContent = val==='pts'?'PTS':'USD';
    document.getElementById('inPrem').placeholder = val==='pts'?'1.80':'180';
    document.getElementById('tTag').textContent = val==='pts'?'PTS':'USD';
    document.getElementById('inTarget').placeholder = val==='pts'?'0.50':'50';
  }
  prog(); calc();
}

function pickGoal(btn, goal) {
  ripple(btn);
  btn.parentElement.querySelectorAll('.opt').forEach(b => { b.className = 'opt'; });
  btn.classList.add('opt');
  const cm = { profit:'on-green', loss:'on-red', be:'on-amber' };
  btn.classList.add(cm[goal]);
  S.goal = goal;
  const area = document.getElementById('tArea');
  const ctx = document.getElementById('tCtx');
  const lbl = document.getElementById('tLbl');
  const inp = document.getElementById('inTarget');
  if (goal === 'be') {
    area.classList.remove('vis'); S.target = 0;
  } else if (goal === 'profit') {
    area.classList.add('vis');
    ctx.className = 'target-ctx cg';
    ctx.textContent = 'üí∞ Ingresa la ganancia m√≠nima que deseas asegurar en el peor escenario.';
    lbl.textContent = 'Ganancia Deseada';
    inp.placeholder = S.unit==='pts'?'0.50':'50';
  } else {
    area.classList.add('vis');
    ctx.className = 'target-ctx cr';
    ctx.textContent = 'üõ°Ô∏è Ingresa la p√©rdida m√°xima que est√°s dispuesto a aceptar.';
    lbl.textContent = 'P√©rdida M√°xima Aceptable';
    inp.placeholder = S.unit==='pts'?'1.00':'100';
  }
  prog(); calc();
}

function ripple(el) {
  const r = document.createElement('span'); r.classList.add('ripple');
  const rc = el.getBoundingClientRect(); const sz = Math.max(rc.width,rc.height);
  r.style.width=r.style.height=sz+'px'; r.style.left='50%'; r.style.top='50%';
  r.style.marginLeft=-(sz/2)+'px'; r.style.marginTop=-(sz/2)+'px';
  el.appendChild(r); setTimeout(()=>r.remove(),600);
}

function prog() {
  const ok = [S.type!==null, S.unit!==null, true, S.buy!==null&&S.sell!==null, S.prem!==null&&S.prem>0, S.goal==='be'||(S.target!==null&&S.target>0)];
  for (let i=0;i<6;i++) {
    const el=document.getElementById('p'+(i+1)); el.className='progress-step';
    if(ok[i]) el.classList.add('done'); else if(i>0&&ok[i-1]) el.classList.add('current');
  }
}

function setInputState(inputId, state) {
  const el = document.getElementById(inputId);
  el.classList.remove('input-err','input-warn','input-ok');
  if (state) el.classList.add('input-' + state);
}

function showAlert(containerId, type, msg) {
  const el = document.getElementById(containerId);
  el.innerHTML += `<div class="alert ${type}"><span class="alert-icon">${type==='warn'?'‚ö†Ô∏è':type==='hint'?'üí°':'‚ÑπÔ∏è'}</span><span>${msg}</span></div>`;
}

function calc() {
  const b=parseFloat(document.getElementById('inBuy').value);
  const s=parseFloat(document.getElementById('inSell').value);
  const p=parseFloat(document.getElementById('inPrem').value);
  const t=parseFloat(document.getElementById('inTarget').value);
  S.buy=isNaN(b)?null:b; S.sell=isNaN(s)?null:s; S.prem=isNaN(p)?null:p; S.target=isNaN(t)?null:t;
  prog();
  document.getElementById('alertStrikes').innerHTML = '';
  document.getElementById('alertPrem').innerHTML = '';
  document.getElementById('alertTarget').innerHTML = '';
  setInputState('inBuy', null);
  setInputState('inSell', null);

  const strikesCard = document.getElementById('strikesCard');
  const strikesNum = document.getElementById('strikesNum');
  let strikesBlockCalc = false;

  if (S.buy !== null && S.sell !== null) {
    const W_raw = Math.abs(S.sell - S.buy);
    const info = document.getElementById('spInfo');
    document.getElementById('spW').textContent = S.unit==='pts' ? W_raw+' pts ($'+(W_raw*100)+')' : '$'+(W_raw*100);
    info.classList.add('vis');
    renderDiagram(S.buy, S.sell, S.type);

    if (S.buy === S.sell) {
      showAlert('alertStrikes', 'warn', '‚ö†Ô∏è Los strikes de compra y venta no pueden ser iguales.');
      setInputState('inBuy', 'err'); setInputState('inSell', 'err');
      strikesBlockCalc = true;
    } else if (W_raw > 50) {
      showAlert('alertStrikes', 'info', `El ancho del spread es muy amplio (${W_raw} pts). Verifica que los strikes sean correctos.`);
    } else if (W_raw < 1) {
      showAlert('alertStrikes', 'warn', 'El ancho del spread es menor a 1 punto. Verifica los strikes.');
      setInputState('inBuy', 'warn'); setInputState('inSell', 'warn');
    }

    const buyMod = S.buy % 5, sellMod = S.sell % 5;
    const buyRoundDown = S.buy - buyMod, buyRoundUp = buyRoundDown + 5;
    const sellRoundDown = S.sell - sellMod, sellRoundUp = sellRoundDown + 5;

    if (buyMod !== 0) {
      setInputState('inBuy', 'warn');
      showAlert('alertStrikes', 'hint', `‚ö° SPX opera en incrementos de <strong>5 puntos</strong>. El strike Buy <strong>${S.buy}</strong> no es v√°lido.<br>¬øQuisiste decir <button class="fix-chip" onclick="document.getElementById('inBuy').value=${buyRoundDown};calc()">‚Üê ${buyRoundDown}</button> o <button class="fix-chip" onclick="document.getElementById('inBuy').value=${buyRoundUp};calc()">‚Üí ${buyRoundUp}</button>?`);
      strikesBlockCalc = true;
    }
    if (sellMod !== 0) {
      setInputState('inSell', 'warn');
      showAlert('alertStrikes', 'hint', `‚ö° SPX opera en incrementos de <strong>5 puntos</strong>. El strike Sell <strong>${S.sell}</strong> no es v√°lido.<br>¬øQuisiste decir <button class="fix-chip" onclick="document.getElementById('inSell').value=${sellRoundDown};calc()">‚Üê ${sellRoundDown}</button> o <button class="fix-chip" onclick="document.getElementById('inSell').value=${sellRoundUp};calc()">‚Üí ${sellRoundUp}</button>?`);
      strikesBlockCalc = true;
    }

    const strikesAreValid5pt = (buyMod === 0 && sellMod === 0);
    if (S.type && S.buy !== S.sell && strikesAreValid5pt) {
      const v = validateStrikes(S.buy, S.sell, S.type);
      if (v && !v.ok) {
        strikesBlockCalc = true;
        strikesCard.classList.add('strike-error'); strikesNum.classList.add('err');
        setInputState('inBuy', 'err'); setInputState('inSell', 'err');
        const spreadNames = { PCS:'Put Credit Spread', CCS:'Call Credit Spread', PDS:'Put Debit Spread', CDS:'Call Debit Spread' };
        const swapInfo = STRIKE_RULES[S.type].swapMsg(S.buy, S.sell);
        showAlert('alertStrikes', 'direction-error',
          `<div class="de-header">‚ùå Strikes incorrectos para <strong>${spreadNames[S.type]}</strong></div>` +
          `<div class="de-body">${v.msg}</div>` +
          `<div class="de-action"><button class="fix-chip fix-chip-lg" onclick="applySwap('${S.type}',${S.buy},${S.sell})">‚Üî Corregir: Buy ${swapInfo.newBuy} / Sell ${swapInfo.newSell}</button></div>`
        );
      } else if (v && v.ok) {
        strikesCard.classList.remove('strike-error'); strikesNum.classList.remove('err');
        if (!strikesBlockCalc) { setInputState('inBuy', 'ok'); setInputState('inSell', 'ok'); }
        const rule = STRIKE_RULES[S.type];
        const alertDiv = document.getElementById('alertStrikes');
        if (!alertDiv.querySelector('.alert')) {
          const dirIcon = rule.dirColor === 'green' ? 'üìà' : 'üìâ';
          alertDiv.innerHTML += `<div class="alert valid-struct"><span class="alert-icon">‚úÖ</span><span>Estructura v√°lida ‚Äî <strong>${S.type}</strong> ¬∑ ${dirIcon} ${rule.dir}</span></div>`;
        }
      }
    } else if (!S.type && S.buy !== S.sell && strikesAreValid5pt) {
      const alertDiv = document.getElementById('alertStrikes');
      if (!alertDiv.querySelector('.alert')) {
        alertDiv.innerHTML += `<div class="alert info"><span class="alert-icon">‚ÑπÔ∏è</span><span>Selecciona el <strong>tipo de spread</strong> en el Paso 1 para validar la direcci√≥n de los strikes.</span></div>`;
      }
    }
  } else {
    document.getElementById('spInfo').classList.remove('vis');
    document.getElementById('strikeDiagram').classList.remove('vis');
    strikesCard.classList.remove('strike-error'); strikesNum.classList.remove('err');
  }

  if (strikesBlockCalc || !S.type || S.buy===null || S.sell===null || S.prem===null || S.prem<=0) {
    document.getElementById('empty').style.display='';
    document.getElementById('resContent').style.display='none';
    document.getElementById('resPanel').classList.remove('has');
    return;
  }

  const W = Math.abs(S.sell - S.buy);
  const P = S.unit==='pts' ? S.prem : S.prem/100;
  const isCredit = (S.type==='PCS'||S.type==='CCS');

  if (S.unit === 'pts' && S.prem >= 100) {
    showAlert('alertPrem', 'info', `Ingresaste ${S.prem} puntos. ¬øQuisiste decir $${S.prem} USD? Si es as√≠, cambia la unidad a D√≥lares.`);
  } else if (S.unit === 'usd' && S.prem > 0 && S.prem < 5) {
    showAlert('alertPrem', 'info', `Ingresaste $${S.prem} USD. ¬øQuisiste decir ${S.prem} puntos? Si es as√≠, cambia la unidad a Puntos.`);
  }
  if (P >= W && W > 0) {
    showAlert('alertPrem', 'warn', isCredit
      ? `La prima recibida (${P.toFixed(2)} pts) no puede ser mayor o igual al ancho del spread (${W} pts).`
      : `El d√©bito pagado (${P.toFixed(2)} pts) no puede ser mayor o igual al ancho del spread (${W} pts).`);
    document.getElementById('empty').style.display='';
    document.getElementById('resContent').style.display='none';
    document.getElementById('resPanel').classList.remove('has');
    return;
  }
  if (P > 0 && P < 0.05) showAlert('alertPrem', 'hint', `La prima de ${P.toFixed(2)} pts ($${(P*100).toFixed(0)}) parece muy baja para un spread de SPX. Verifica que no sea un error de entrada.`);
  if (W > 0 && P > 0 && P / W > 0.8 && P < W) showAlert('alertPrem', 'hint', `La prima (${P.toFixed(2)} pts) es mayor al 80% del ancho del spread (${W} pts). Esto es inusual ‚Äî verifica el valor ingresado.`);
  if (P <= 0) { showAlert('alertPrem', 'warn', 'La prima debe ser un valor positivo.'); return; }

  let goalPts = 0;
  if (S.goal==='profit' && S.target>0) goalPts = S.unit==='pts' ? S.target : S.target/100;
  if (S.goal==='loss' && S.target>0) goalPts = S.unit==='pts' ? S.target : S.target/100;
  if (S.goal === 'profit' && goalPts > 0 && goalPts >= W) showAlert('alertTarget', 'warn', 'La ganancia deseada no puede ser mayor o igual al ancho del spread.');
  if (S.goal === 'loss' && goalPts > 0 && goalPts >= W) showAlert('alertTarget', 'warn', 'La p√©rdida m√°xima no puede ser mayor o igual al ancho del spread.');
  if (S.goal === 'profit' && S.unit === 'pts' && S.target >= 100) showAlert('alertTarget', 'info', `Ingresaste ${S.target} puntos. ¬øQuisiste decir $${S.target}? Si es as√≠, cambia a D√≥lares.`);
  if (S.goal !== 'be' && S.unit === 'usd' && S.target > 0 && S.target < 5) showAlert('alertTarget', 'info', `Ingresaste $${S.target} USD. ¬øQuisiste decir ${S.target} puntos? Si es as√≠, cambia a Puntos.`);

  document.getElementById('empty').style.display='none';
  document.getElementById('resContent').style.display='';
  document.getElementById('resPanel').classList.add('has');

  const lockOps = {
    PCS: { lock: 'Call Credit Spread (CCS)', structure: 'Iron Condor', dir: 'bajista' },
    CCS: { lock: 'Put Credit Spread (PCS)', structure: 'Iron Condor', dir: 'alcista' },
    PDS: { lock: 'Call Debit Spread (CDS)', structure: 'Box Spread', dir: 'alcista' },
    CDS: { lock: 'Put Debit Spread (PDS)', structure: 'Box Spread', dir: 'bajista' }
  };
  const lockInfo = lockOps[S.type];

  let required;
  if (isCredit) {
    if (S.goal==='be')     required = W - P;
    if (S.goal==='profit') required = W - P + goalPts;
    if (S.goal==='loss')   required = W - P - goalPts;
  } else {
    if (S.goal==='be')     required = W - P;
    if (S.goal==='profit') required = W - P - goalPts;
    if (S.goal==='loss')   required = W - P + goalPts;
  }

  const lockLabel = isCredit
    ? (S.goal==='profit' ? 'CR√âDITO PARA ASEGURAR GANANCIA' : S.goal==='loss' ? 'CR√âDITO PARA LIMITAR P√âRDIDA' : 'CR√âDITO PARA BREAK-EVEN')
    : (S.goal==='profit' ? 'D√âBITO M√ÅXIMO PARA ASEGURAR GANANCIA' : S.goal==='loss' ? 'D√âBITO M√ÅXIMO PARA LIMITAR P√âRDIDA' : 'D√âBITO M√ÅXIMO PARA BREAK-EVEN');
  const lockSub = isCredit ? 'Cr√©dito m√≠nimo que debes cobrar en el ' + lockInfo.lock : 'D√©bito m√°ximo que puedes pagar en el ' + lockInfo.lock;

  if (required <= 0) {
    document.getElementById('rVal').innerHTML = 'N/A';
    document.getElementById('rVal').className = 'r-val neu';
    document.getElementById('rLabel').textContent = 'OBJETIVO NO ALCANZABLE';
    document.getElementById('rSub').textContent = 'La combinaci√≥n de par√°metros no permite este objetivo. Ajusta la ganancia/p√©rdida deseada.';
    document.getElementById('rConv').textContent = '';
    document.getElementById('tWrap').style.display = 'none';
    document.getElementById('edu').classList.remove('vis');
    return;
  }

  const uSuf = S.unit==='pts'?' pts':' USD';
  const dVal = S.unit==='pts' ? required.toFixed(2) : (required*100).toFixed(0);
  const vEl = document.getElementById('rVal');
  vEl.innerHTML = dVal + '<span class="r-unit">'+uSuf+'</span>';
  vEl.className = 'r-val pop pos';
  document.getElementById('rLabel').textContent = lockLabel;
  document.getElementById('rSub').textContent = lockSub;
  document.getElementById('rConv').textContent = S.unit==='pts' ? '= $'+(required*100).toFixed(0)+' USD' : '= '+required.toFixed(2)+' pts';

  const tw = document.getElementById('tWrap');
  const tb = document.getElementById('tBox');
  if (S.goal!=='be' && S.target>0) {
    tw.style.display=''; tb.classList.add('vis');
    const tv = S.target;
    if (S.goal==='profit') {
      document.getElementById('tDivLbl').textContent='Tu Objetivo de Ganancia';
      document.getElementById('tBoxLbl').className='t-lbl lg';
      document.getElementById('tBoxLbl').textContent='GANANCIA M√çNIMA GARANTIZADA';
      document.getElementById('tBoxVal').textContent='+'+(S.unit==='pts'?tv.toFixed(2)+' pts':'$'+tv.toFixed(0));
      document.getElementById('tBoxVal').className='t-val vg';
      document.getElementById('tBoxSub').textContent=S.unit==='pts'?'= $'+(tv*100).toFixed(0)+' USD en el peor caso':'= '+(tv/100).toFixed(2)+' pts en el peor caso';
      document.getElementById('tBoxExpl').innerHTML=isCredit?'Cobra al menos <strong>'+dVal+uSuf+'</strong> en el <strong>'+lockInfo.lock+'</strong> para asegurar esta ganancia.':'Paga como m√°ximo <strong>'+dVal+uSuf+'</strong> en el <strong>'+lockInfo.lock+'</strong> para asegurar esta ganancia.';
    } else {
      document.getElementById('tDivLbl').textContent='Tu L√≠mite de P√©rdida';
      document.getElementById('tBoxLbl').className='t-lbl lr';
      document.getElementById('tBoxLbl').textContent='P√âRDIDA M√ÅXIMA CON BLOQUEO';
      document.getElementById('tBoxVal').textContent='-'+(S.unit==='pts'?tv.toFixed(2)+' pts':'$'+tv.toFixed(0));
      document.getElementById('tBoxVal').className='t-val vr';
      document.getElementById('tBoxSub').textContent=S.unit==='pts'?'= -$'+(tv*100).toFixed(0)+' USD m√°ximo':'= -'+(tv/100).toFixed(2)+' pts m√°ximo';
      document.getElementById('tBoxExpl').innerHTML=isCredit?'Cobra al menos <strong>'+dVal+uSuf+'</strong> en el <strong>'+lockInfo.lock+'</strong> para limitar tu p√©rdida.':'Paga como m√°ximo <strong>'+dVal+uSuf+'</strong> en el <strong>'+lockInfo.lock+'</strong> para limitar tu p√©rdida.';
    }
  } else { tw.style.display='none'; tb.classList.remove('vis'); }

  document.getElementById('edu').classList.add('vis');
  buildEdu(isCredit, W, P, required, goalPts, lockInfo);
}

function buildEdu(isCredit, W, P, X, G, lockInfo) {
  const f = v => v.toFixed(2);
  const c = (col, txt) => `<span style="color:var(--accent-${col});font-weight:600">${txt}</span>`;
  const spreadName = { PCS:'Put Credit Spread', CCS:'Call Credit Spread', PDS:'Put Debit Spread', CDS:'Call Debit Spread' }[S.type];
  const varsEl = document.getElementById('eduVars');
  const badgeClass = isCredit ? 'lb-credit' : 'lb-debit';
  let html = `<div class="lock-badge ${badgeClass}"><span class="lb-arrow">üîí</span><span><span class="lb-name">${spreadName}</span> se bloquea con ‚Üí <strong>${lockInfo.lock}</strong><br><span style="font-size:.75rem;font-weight:400;opacity:.8">Esto forma un <strong>${lockInfo.structure}</strong> ‚Äî el spread opuesto es ${lockInfo.dir}</span></span></div>`;
  html += `<div style="display:flex;flex-wrap:wrap;gap:8px">`;
  html += `<div class="ev"><span class="ev-icon">üìè</span><span class="ev-name">Ancho del Spread =</span><span class="ev-val">${f(W)}</span></div>`;
  html += `<div class="ev"><span class="ev-icon">${isCredit?'üí∞':'üí∏'}</span><span class="ev-name">${isCredit?'Prima Recibida':'D√©bito Pagado'} =</span><span class="ev-val">${f(P)}</span></div>`;
  if (S.goal==='profit') html += `<div class="ev"><span class="ev-icon">üéØ</span><span class="ev-name">Ganancia Deseada =</span><span class="ev-val">${f(G)}</span></div>`;
  if (S.goal==='loss') html += `<div class="ev"><span class="ev-icon">üõ°Ô∏è</span><span class="ev-name">P√©rdida M√°xima =</span><span class="ev-val">${f(G)}</span></div>`;
  html += `</div>`;
  varsEl.innerHTML = html;

  const sEl = document.getElementById('eduSteps');
  let s = '';
  if (isCredit) {
    s += step(1, `Abriste un <strong>${spreadName}</strong> y cobraste ${c('amber',f(P))} de prima. Tu riesgo m√°ximo sin bloqueo:`, `${c('blue','Ancho')} ‚àí ${c('amber','Prima Recibida')} = ${f(W)} ‚àí ${f(P)} = ${c('red',f(W-P))}`);
    s += step(2, `Para bloquear, abres un <strong>${lockInfo.lock}</strong> (${lockInfo.dir}) del mismo ancho. Ambos credit spreads forman un <strong>${lockInfo.structure}</strong>. En el peor caso, uno pierde el ancho completo:`, `Peor caso = ${c('amber','Prima Recibida')} + ${c('green','Cr√©dito Opuesto')} ‚àí ${c('blue','Ancho')}`);
    if (S.goal==='be') {
      s += step(3, `Para <strong>break-even</strong>, el peor caso debe ser $0:`, `${c('amber','Prima Recibida')} + ${c('green','Cr√©dito Opuesto')} ‚àí ${c('blue','Ancho')} = 0`);
      s += stepR(`${c('green','Cr√©dito Opuesto')} = ${c('blue','Ancho')} ‚àí ${c('amber','Prima Recibida')}<br>${c('green','Cr√©dito Opuesto')} = ${f(W)} ‚àí ${f(P)} = <span style="color:var(--accent-green);font-size:1.15em"><strong>${f(X)}</strong></span>`);
    } else if (S.goal==='profit') {
      s += step(3, `Para asegurar una ganancia de ${c('green',f(G))}, el peor caso debe igualar esa ganancia:`, `${c('amber','Prima Recibida')} + ${c('green','Cr√©dito Opuesto')} ‚àí ${c('blue','Ancho')} = ${c('green','Ganancia Deseada')}`);
      s += stepR(`${c('green','Cr√©dito Opuesto')} = ${c('blue','Ancho')} ‚àí ${c('amber','Prima Recibida')} + ${c('green','Ganancia Deseada')}<br>${c('green','Cr√©dito Opuesto')} = ${f(W)} ‚àí ${f(P)} + ${f(G)} = <span style="color:var(--accent-green);font-size:1.15em"><strong>${f(X)}</strong></span>`);
    } else {
      s += step(3, `Para limitar la p√©rdida a ${c('red',f(G))}, el resultado neto del bloqueo debe ser exactamente esa p√©rdida:`, `${c('amber','Prima Recibida')} + ${c('green','Cr√©dito Opuesto')} ‚àí ${c('blue','Ancho')} = ${c('red','P√©rdida M√°xima')}`);
      s += stepR(`${c('green','Cr√©dito Opuesto')} = ${c('blue','Ancho')} ‚àí ${c('amber','Prima Recibida')} ‚àí ${c('red','P√©rdida M√°xima')}<br>${c('green','Cr√©dito Opuesto')} = ${f(W)} ‚àí ${f(P)} ‚àí ${f(G)} = <span style="color:var(--accent-green);font-size:1.15em"><strong>${f(X)}</strong></span>`);
    }
  } else {
    s += step(1, `Abriste un <strong>${spreadName}</strong> y pagaste ${c('amber',f(P))} de d√©bito. Tu riesgo m√°ximo es lo que pagaste:`, `Riesgo original = ${c('amber','D√©bito Pagado')} = ${c('red',f(P))}`);
    s += step(2, `Para bloquear, abres un <strong>${lockInfo.lock}</strong> (${lockInfo.dir}) del mismo ancho. Ambos debit spreads forman un <strong>${lockInfo.structure}</strong> que vale exactamente el ancho al expirar:`, `Valor al expirar = ${c('blue','Ancho')} = ${c('green',f(W))}<br>Costo total = ${c('amber','D√©bito Original')} + ${c('purple','D√©bito del ' + lockInfo.lock)}<br>Ganancia = ${c('blue','Ancho')} ‚àí Costo total`);
    if (S.goal==='be') {
      s += step(3, `Para <strong>break-even</strong>, la ganancia debe ser $0:`, `${c('blue','Ancho')} ‚àí ${c('amber','D√©bito Original')} ‚àí ${c('purple','D√©bito Bloqueo')} = 0`);
      s += stepR(`${c('purple','D√©bito Bloqueo')} = ${c('blue','Ancho')} ‚àí ${c('amber','D√©bito Original')}<br>${c('purple','D√©bito Bloqueo')} = ${f(W)} ‚àí ${f(P)} = <span style="color:var(--accent-purple);font-size:1.15em"><strong>${f(X)}</strong></span>`);
    } else if (S.goal==='profit') {
      s += step(3, `Para asegurar una ganancia de ${c('green',f(G))}, el resultado debe ser al menos esa ganancia:`, `${c('blue','Ancho')} ‚àí ${c('amber','D√©bito Original')} ‚àí ${c('purple','D√©bito Bloqueo')} = ${c('green','Ganancia Deseada')}`);
      s += stepR(`${c('purple','D√©bito Bloqueo')} = ${c('blue','Ancho')} ‚àí ${c('amber','D√©bito Original')} ‚àí ${c('green','Ganancia Deseada')}<br>${c('purple','D√©bito Bloqueo')} = ${f(W)} ‚àí ${f(P)} ‚àí ${f(G)} = <span style="color:var(--accent-purple);font-size:1.15em"><strong>${f(X)}</strong></span>`);
    } else {
      s += step(3, `Para limitar la p√©rdida a ${c('red',f(G))}, el resultado neto del bloqueo debe ser exactamente esa p√©rdida:`, `${c('blue','Ancho')} ‚àí ${c('amber','D√©bito Original')} ‚àí ${c('purple','D√©bito Bloqueo')} = ${c('red','P√©rdida M√°xima')}`);
      s += stepR(`${c('purple','D√©bito Bloqueo')} = ${c('blue','Ancho')} ‚àí ${c('amber','D√©bito Original')} + ${c('red','P√©rdida M√°xima')}<br>${c('purple','D√©bito Bloqueo')} = ${f(W)} ‚àí ${f(P)} + ${f(G)} = <span style="color:var(--accent-purple);font-size:1.15em"><strong>${f(X)}</strong></span>`);
    }
  }
  sEl.innerHTML = s;

  const tip = document.getElementById('eduTip');
  const fmt = v => S.unit==='pts' ? v.toFixed(2)+' pts' : '$'+(v*100).toFixed(0);
  if (S.goal==='profit') {
    tip.innerHTML = `<div class="edu-tip tg">üí° Si ${isCredit?'cobras al menos':'pagas como m√°ximo'} <strong>${fmt(X)}</strong> en el <strong>${lockInfo.lock}</strong>, tu ganancia queda <strong>garantizada</strong> sin importar hacia d√≥nde se mueva el precio al expirar.</div>`;
  } else if (S.goal==='loss') {
    tip.innerHTML = `<div class="edu-tip ta">üí° Con ${isCredit?'un cr√©dito':'un d√©bito'} de <strong>${fmt(X)}</strong> en el <strong>${lockInfo.lock}</strong>, tu p√©rdida m√°xima queda limitada. ${isCredit?'Si cobras m√°s':'Si pagas menos'}, la p√©rdida ser√° a√∫n menor.</div>`;
  } else {
    tip.innerHTML = `<div class="edu-tip tb">üí° Con exactamente <strong>${fmt(X)}</strong> en el <strong>${lockInfo.lock}</strong> llegas a break-even. ${isCredit?'Cualquier cr√©dito por encima':'Cualquier d√©bito por debajo'} de eso se convierte en <strong>ganancia garantizada</strong>.</div>`;
  }
}

function step(n, desc, eq) {
  return `<div class="es"><div class="es-n">${n}</div><div class="es-b"><div class="es-d">${desc}</div><div class="es-eq">${eq}</div></div></div>`;
}
function stepR(eq) {
  return `<div class="es"><div class="es-n done">‚úì</div><div class="es-b"><div class="es-d">Despejamos el valor necesario del spread opuesto:</div><div class="es-eq final">${eq}</div></div></div>`;
}

prog();
</script>
</body>
</html>
